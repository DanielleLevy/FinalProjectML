---
title: "Gracia Moreno ChIP Seq Analysis Report"
author: "Roni Weiss"
date: "24/10/2022"
output:
  html_document:

    toc: true

    toc_depth: 3

    toc_float: true
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = FALSE, message = FALSE, cache=F)
knitr::opts_chunk$set(fig.width=4.5, fig.height=3.5, results='asis')
knitr::opts_chunk$set(fig.pos = "!H", out.extra = "", fig_crop = FALSE)
library(grid)
library(gridExtra)
library(futile.logger)
library(VennDiagram)
library(ggplot2)
library(dplyr)
library(DiagrammeR)
library(tidyr)
library(knitr)
library(rJava)
library(venneuler)
library(eulerr)
library(ggpubr)
library(scales)
library(kableExtra)
library(ggvenn)
library(UpSetR)
library(forcats)
library(magick)
#library(ComplexUpset)
crop <- function(im, left = 0, top = 0, right = 0, bottom = 0) {
  d <- dim(im[[1]]); w <- d[2]; h <- d[3]
  image_crop(im, glue::glue("{w-left-right}x{h-top-bottom}+{left}+{top}"))
}
```

# Quality Check



In this report, we compare ChIP-Seq of H3K4me3 (promoters), H3K27Ac (enhancers) and H3K27me3 (silencers) generated by the Maatouk lab (GM data), with ATAC Seq data from Gonen lab. All samples are at the E13.5 gonadal stage.
\n
GM data has 12 samples - duplicates of Sertoli and Granulosa cells, testing H3K4me3, H3K27Ac and H3K27me3 antibodies, all samples are single end.

In order to analyze the ChIP seq data I used an automated ChIP seq pipeline by nf-core.

## QC of reads

# read input file
peaks <- read.table("pre_granulosa_overlaps_table.txt", sep="\t", header=TRUE)

# extract numeric values from fifth column
peak_lengths <- as.numeric(gsub("[^[:digit:].]", "", peaks[,5]))
# print peak_lengths
print(peak_lengths)
# check if peak_lengths is empty or contains only NA values
if (is.na(sum(peak_lengths)) || length(peak_lengths) == 0) {
  stop("No valid peak lengths found in input file.")
}

# create histogram
hist(peak_lengths, breaks=1000, col="blue",
     xlab="Peak Length", ylab="Frequency",
     main="Distribution of Peak Lengths")
###########

# read input files
peaksA <- read.table("all_human_merge_table.txt", sep="\t", header=TRUE)
peaksB <- read.table("all_mouse_merge_overlaps_table.txt", sep="\t", header=TRUE)
peaksC <- read.table("all_mouse_to_human_merge_overlaps_table.txt", sep="\t", header=TRUE)

# extract numeric values from the fifth column for each file
peak_lengthsA <- as.numeric(gsub("[^[:digit:].]", "", peaksA[,5]))
peak_lengthsB <- as.numeric(gsub("[^[:digit:].]", "", peaksB[,5]))
peak_lengthsC <- as.numeric(gsub("[^[:digit:].]", "", peaksC[,5]))

# check if any peak_lengths variables are empty or contain only NA values
if (is.na(sum(peak_lengthsA)) || length(peak_lengthsA) == 0) {
   stop("No valid peak lengths found in myA.txt.")
}
if (is.na(sum(peak_lengthsB)) || length(peak_lengthsB) == 0) {
   stop("No valid peak lengths found in myB.txt.")
}
if (is.na(sum(peak_lengthsC)) || length(peak_lengthsC) == 0) {
   stop("No valid peak lengths found in myC.txt.")
}

# create separate histograms for each file
png("human_peak_size_histogram.png")
hist(peak_lengthsA, breaks=1000, col="blue",
      xlab="Peak Length", ylab="Frequency",
      main="Distribution of Peak Lengths in human (merged all)")
dev.off()

png("mouse_peak_size_histogram.png")
hist(peak_lengthsB, breaks=1000, col="green",
      xlab="Peak Length", ylab="Frequency",
      main="Distribution of Peak Lengths in mouse (merged all)")
dev.off()

png("mouse_to_human_peak_size_histogram.png")
hist(peak_lengthsC, breaks=1000, col="red",
      xlab="Peak Length", ylab="Frequency",
      main="Distribution of Peak Lengths in mouse to human (merged all)")
dev.off()

# create combined histogram for all files
png("compare_sizes_histogram.png")
hist(peak_lengthsA, breaks=1000, col="blue", density=10,
      xlab="Peak Length", ylab="Frequency",
      main="Distribution of Peak Lengths in human, mouse, mouse to human")
hist(peak_lengthsB, breaks=1000, col="green", density=10, add=TRUE)
hist(peak_lengthsC, breaks=1000, col="red", density=10, add=TRUE)
legend("topright", c("human", "mouse", "mouse to human"), fill=c("blue", "green", "red"))
dev.off()
######

## human:

# Load necessary libraries
library (plotrix)
library(grDevices)

# Define the list of names and percentages
names_list <- c("4 files merged", "Pre granulosa", "Pre Sertoli", "XX supporting",
                 "XY supporting", "granulosa + sertoli", "XX + XY", "XX + granulosa",
                 "XY + sertoli")
percentages <- c(2.05, 1.47, 1.22, 1.85, 0.94, 1.69, 1.88, 1.89, 1.27)

# Loop through each name and percentage to create a pie chart
for (i in 1:length(names_list)) {
  
  # Define the labels and colors for the pie chart
  labels <- c("Exome", "Regulatory elements", "Non-coded")
  colors <- c("lightblue", "pink", "purple")
  
  # Define the values for each part of the pie chart
  exome_val <- 2
  reg_val <- percentages[i]
  non_coded_val <- 100 - exome_val - reg_val
  values <- c(exome_val, reg_val, non_coded_val)
  
  # Create the pie chart with the specified labels, values, and colors
  png(paste(names_list[i], "_regulatory_elements.png", sep=""), width=500, height=500)
  par(mar=c(1,1,1,1))
  pie(values, labels = "", col = colors, main = paste(names_list[i], "regulatory elements"))
  legend("bottomleft", legend = paste(labels, "(", format(values, nsmall=2), "%", ")", sep=""), fill = colors, bty = "n")
  dev.off()
  
}



## mouse:
# Load necessary libraries
library(plotrix)
library(grDevices)

# Define the list of names and percentages
names_list <- c("4 files merged", "E13 granulosa", "E15 granulosa", "E13 sertoli",
                "E15 sertoli", "E13", "E15", "Granulosa", "Sertoli")
percentages <- c(1.65, 0.99, 0.64, 1.24, 0.85, 1.54, 1.07, 1.06, 1.33)

# Loop through each name and percentage to create a pie chart
for (i in 1:length(names_list)) {

  # Define the labels and colors for the pie chart
  labels <- c("Exome", "Regulatory elements", "Non-coded")
  colors <- c("lightblue", "pink", "purple")

  # Define the values for each part of the pie chart
  exome_val <- 2
  reg_val <- percentages[i]
  non_coded_val <- 100 - exome_val - reg_val
  values <- c(exome_val, reg_val, non_coded_val)

  # Create the pie chart with the specified labels, values, and colors
  png(paste(names_list[i], "_regulatory_elements.png", sep=""), width=500, height=500)
  par(mar=c(1,1,1,1))
  pie(values, labels = "", col = colors, main = paste(names_list[i], "regulatory elements"))
  legend("bottomleft", legend = paste(labels, "(", format(values, nsmall=2), "%", ")", sep=""), fill = colors, bty = "n")
  dev.off()

}

#mouse to human:
# Load necessary libraries
library(plotrix)
library(grDevices)

# Define the list of names and percentages
names_list <- c("4 files merged", "E13 granulosa", "E15 granulosa", "E13 sertoli",
                "E15 sertoli", "E13", "E15", "Granulosa", "Sertoli")
percentages <- c(1.21, 0.75, 0.51, 0.91, 0.64, 1.13, 0.81, 0.80, 0.97)

# Loop through each name and percentage to create a pie chart
for (i in 1:length(names_list)) {

  # Define the labels and colors for the pie chart
  labels <- c("Exome", "Regulatory elements", "Non-coded")
  colors <- c("lightblue", "pink", "purple")

  # Define the values for each part of the pie chart
  exome_val <- 2
  reg_val <- percentages[i]
  non_coded_val <- 100 - exome_val - reg_val
  values <- c(exome_val, reg_val, non_coded_val)

  # Create the pie chart with the specified labels, values, and colors
  png(paste(names_list[i], "_regulatory_elements.png", sep=""), width=500, height=500)
  par(mar=c(1,1,1,1))
  pie(values, labels = "", col = colors, main = paste(names_list[i], "regulatory elements"))
  legend("bottomleft", legend = paste(labels, "(", format(values, nsmall=2), "%", ")", sep=""), fill = colors, bty = "n")
  dev.off()

}


library(VennDiagram)

# read in the text file
data <- read.table("pre_granulosa_HO_VS._pre_sertoli_HO.txt", header = TRUE, sep = "\t")

# convert the last row values from string to numeric
a_size <- as.numeric(data[nrow(data), 5])
b_size <- as.numeric(data[nrow(data), 6])
common_size <- as.numeric(data[nrow(data), 4])

# create the Venn diagram
venn.plot <- draw.pairwise.venn(area1 = a_size, area2 = b_size, cross.area = common_size, 
                                 category = c("Circle A", "Circle B"), fill = c("pink", "lightblue"), 
                                 alpha = 0.5, cex = 1.5, cat.cex = 1.5, cat.pos = c(-25, 25))

# add labels to each circle and the common area
venn.plot <- draw.pairwise.venn(area1 = a_size, area2 = b_size, cross.area = common_size, 
                                 category = c("Circle A", "Circle B"), fill = c("pink", "lightblue"), 
                                 alpha = 0.5, cex = 1.5, cat.cex = 1.5, cat.pos = c(-25, 25),
                                 cat.dist = c(0.15, 0.15), cat.col = c("black", "black"),
                                 cat.fontface = c("bold", "bold"), 
                                 sigdigs = 3)

# add a title to the plot
title(main = "Comparison between Circle A and Circle B")

# save the plot to a file
pdf("venn_diagram.pdf")
grid.draw(venn.plot)
dev.off()
###################3



library(VennDiagram)
library(grid)

# read in the data from the text file
data <- read.table("pre_granulosa_HO_VS._pre_sertoli_HO.txt", header = TRUE, sep = "\t")

# extract the sizes of circle A, circle B, and their common area from the last row of the data
a_size <- as.numeric(data[nrow(data), 5])
b_size <- as.numeric(data[nrow(data), 6])
common_size <- as.numeric(data[nrow(data), 4])

# create the Venn diagram
venn.plot <- draw.pairwise.venn(area1 = a_size, area2 = b_size, cross.area = common_size, 
                                 category = c("Circle A", "Circle B"), fill = c("pink", "lightblue"), 
                                 alpha = 0.5, cex = 1.5, cat.cex = 1.5, cat.pos = c(-25, 25),
                                 cat.dist = c(0.15, 0.15), cat.col = c("black", "black"),
                                 cat.fontface = c("bold", "bold"), 
                                 sigdigs = 3)

# add a title to the plot
title(main = "Comparison between Circle A and Circle B")

# save the plot to a file
pdf("venn_diagram.pdf")
grid.draw(venn.plot)
dev.off()




# Load the required libraries
library(VennDiagram)
library(grid)

# Define circle sizes and common area size
circleA <- 500000
circleB <- 400000
commonArea <- 180000

# Create the Venn diagram
venn.diagram(
  x = list(A = circleA, B = circleB),
  filename = "venn_diagram.png",
  col = c("deeppink", "skyblue"),
  lty = "blank",
  alpha = c(0.5, 0.5),
  col.label = c("deeppink", "skyblue"),
  cat.col = c("deeppink", "skyblue"),
  cat.cex = 1.5,
  cat.fontface = "bold",
  cat.default.pos = "outer",
  cex = 1.5,
  fontface = "bold",
  cat.dist = c(0.08, 0.08),
  cat.pos = c(-20, 20),
  margin = 0.1,
  main = "Comparison between circle A and circle B"
)

# Fill circle A with pink color
grid.circle(x = unit(0.28, "npc"), y = unit(0.5, "npc"), 
            r = unit(0.38, "npc"), gp = gpar(fill = "deeppink", alpha = 0.7))

# Fill circle B with light blue color
grid.circle(x = unit(0.72, "npc"), y = unit(0.5, "npc"), 
            r = unit(0.38, "npc"), gp = gpar(fill = "skyblue", alpha = 0.7))

# Fill the common area with purple color
grid.circle(x = unit(0.5, "npc"), y = unit(0.5, "npc"), 
            r = unit(0.28, "npc"), gp = gpar(fill = "purple", alpha = 0.7))

# load Venn diagram package
library("VennDiagram")

# move to new plotting page
grid.newpage()

# create pairwise Venn diagram
draw.pairwise.venn(area1=500000, area2=400000,cross.area=180000,
				category=c("Mango","Banana"),fill=c("Pink","Lightblue"))


library(VennDiagram)
grid.newpage()
draw.pairwise.venn(22, 20, 11, category = c("Dog People", "Cat People"), lty = rep("blank",
     2), fill = c("light blue", "pink"), alpha = rep(0.5, 2), cat.pos = c(0,
     0), cat.dist = rep(0.025, 2))
plot.new() # add this line to create a new plot object
title("Dog People vs Cat People Venn Diagram", cex.main = 1.2)
png("venn_diagram.png")
dev.off()

library(VennDiagram)
grid.newpage()
vp <- viewport(width = 0.8, height = 0.8) # create a new viewport
pushViewport(vp) # make it the active viewport
draw.pairwise.venn(22, 20, 11, category = c("Dog People", "Cat People"), lty = rep("blank",
     2), fill = c("light blue", "pink"), alpha = rep(0.5, 2), cat.pos = c(0,
     0), cat.dist = rep(0.025, 2))
title("Dog People vs Cat People Venn Diagram", cex.main = 1.2)
popViewport() # reset to the default viewport
png("venn_diagram.png")
grid.draw(vp) # draw the viewport to the image
dev.off()



grid.newpage()
draw.pairwise.venn(22, 20, 11, category = c("Dog People", "Cat People"), lty = rep("blank", 
    2), fill = c("light blue", "pink"), alpha = rep(0.5, 2), cat.pos = c(0, 
    0), cat.dist = rep(0.025, 2))


# Load the required library
library(VennDiagram)

# Define the areas of the circles and their overlap
areaA <- 500000
areaB <- 400000
overlap <- 180000

# Convert the area values from strings to numbers
areaA <- as.numeric(areaA)
areaB <- as.numeric(areaB)
overlap <- as.numeric(overlap)

# Create the Venn diagram
venn.diagram <- draw.pairwise.venn(
  area1 = areaA, area2 = areaB, cross.area = overlap,
  category = c("Circle A", "Circle B"),
  fill = c("pink", "lightblue"), lty = "blank",
  cat.col = c("black", "black"), cat.cex = 1.5,
  cat.fontfamily = "serif", cat.fontface = "bold",
  scaled = TRUE
)

# Add the area values next to each circle
grid.text(
  paste0(formatC(areaA, big.mark = ","), "\nCircle A"), x = unit(-0.2, "npc"),
  y = unit(0.3, "npc"), just = c("right", "top"), gp = gpar(fontsize = 12)
)
grid.text(
  paste0(formatC(areaB, big.mark = ","), "\nCircle B"), x = unit(0.2, "npc"),
  y = unit(0.3, "npc"), just = c("left", "top"), gp = gpar(fontsize = 12)
)

# Add the overlap value in the middle of the Venn diagram
grid.text(
  paste0(formatC(overlap, big.mark = ","), "\nOverlap"), just = "center",
  gp = gpar(fontsize = 12)
)

# Create the title and save the plot as a PNG image
title <- "Comparison between Circle A and Circle B"
grid.arrange(
  arrangeGrob(grid.text(title, gp = gpar(fontsize = 20, fontface = "bold")), 
              top = "-1cm", left = "4cm"),
  venn.diagram,
  ncol = 2
)
ggsave("venn_diagram.png", width = 10, height = 5, dpi = 150, units = "in")

install.packages("VennDiagram")

# Load the VennDiagram library
library(VennDiagram)

# Define circle sizes and common area size
circleA <- 500000
circleB <- 400000
commonArea <- 180000

# Create the Venn diagram
venn.diagram(
  x = list(A = circleA, B = circleB),
  filename = "venn_diagram.png",
  col = c("deeppink", "skyblue"),
  fill = c("deeppink", "skyblue", "purple"),
  alpha = c(0.5, 0.5, 0.7),
  col.label = c("deeppink", "skyblue"),
  cat.col = c("deeppink", "skyblue"),
  cat.cex = 1.5,
  cat.fontface = "bold",
  cat.default.pos = "outer",
  cex = 1.5,
  fontface = "bold",
  cat.dist = c(0.08, 0.08),
  cat.pos = c(-20, 20),
  margin = 0.1,
  main = "Comparison between circle A and circle B"
)

# Load the VennDiagram library
library(VennDiagram)

# Define circle sizes and common area size
circleA <- 500000
circleB <- 400000
commonArea <- 180000

# Create the Venn diagram
venn.diagram(
  x = list(A = circleA, B = circleB),
  filename = "venn_diagram.png",
  col = c("deeppink", "skyblue"),
  fill = c("deeppink", "skyblue", "purple"),
  alpha = c(0.5, 0.5, 0.7),
  label.col = c("deeppink", "skyblue"),
  cat.col = c("deeppink", "skyblue"),
  cat.cex = 1.5,
  cat.fontface = "bold",
  cat.default.pos = "outer",
  cex = 1.5,
  fontface = "bold",
  cat.dist = c(0.08, 0.08),
  cat.pos = c(-20, 20),
  margin = 0.1,
  main = "Comparison between circle A and circle B"
)






#####################
library(VennDiagram)

# Read in the two files
file1 <- read.table("pre_granulosa_overlaps.txt", header=TRUE, sep="\t")
file2 <- read.table("pre_sertoli_overlaps.txt", header=TRUE, sep="\t")

# Create named vectors for each chromosome in each file
file1_vec <- lapply(unique(file1$Chromosome), function(chr){
  chr_pos <- paste(file1$Position[file1$Chromosome==chr], collapse=",")
  names(chr_pos) <- chr
  return(chr_pos)
})
file2_vec <- lapply(unique(file2$Chromosome), function(chr){
  chr_pos <- paste(file2$Position[file2$Chromosome==chr], collapse=",")
  names(chr_pos) <- chr
  return(chr_pos)
})

# Create a Venn diagram of the overlapping regions
venn_regions <- venn.diagram(
  x=file1_vec,
  y=file2_vec,
  filename=NULL,
  fill=c("skyblue","pink"),
  alpha=c(0.6,0.6),
  cat.col=c("skyblue","pink"),
  cat.cex=2,
  main=paste("File1 VS. File2")
)

# Add the region sizes as labels
venn_regions$labels <- c(
  paste(length(setdiff(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Unique to File1"),
  paste(length(intersect(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Overlap"),
  paste(length(setdiff(unlist(file2_vec), unlist(file1_vec))), "bp\n", "Unique to File2")
)

# Draw the diagram
png("venn_diagram.png", width=1000, height=1000)
grid.draw(venn_regions)
dev.off()



##############3
library(VennDiagram)

# Read in the two files
file1 <- read.table("pre_granulosa_overlaps.txt", header=TRUE, sep="\t")
file2 <- read.table("pre_sertoli_overlaps.txt", header=TRUE, sep="\t")

# Create named vectors for each chromosome in each file
file1_vec <- lapply(unique(file1$Chromosome), function(chr){
   chr_pos <- paste(file1$Position[file1$Chromosome==chr], collapse=",")
   names(chr_pos) <- chr
   return(chr_pos)
})
file2_vec <- lapply(unique(file2$Chromosome), function(chr){
   chr_pos <- paste(file2$Position[file2$Chromosome==chr], collapse=",")
   names(chr_pos) <- chr
   return(chr_pos)
})

# Get all unique chromosome names from both files
all_chr <- unique(c(file1$Chromosome, file2$Chromosome))

# Create named vectors for each chromosome, filling in with empty strings if chromosome is not present in a file
file1_vec <- lapply(all_chr, function(chr){
   if (chr %in% unique(file1$Chromosome)) {
      chr_pos <- paste(file1$Position[file1$Chromosome==chr], collapse=",")
      names(chr_pos) <- chr
   } else {
      chr_pos <- ""
   }
   return(chr_pos)
})
file2_vec <- lapply(all_chr, function(chr){
   if (chr %in% unique(file2$Chromosome)) {
      chr_pos <- paste(file2$Position[file2$Chromosome==chr], collapse=",")
      names(chr_pos) <- chr
   } else {
      chr_pos <- ""
   }
   return(chr_pos)
})

# Create a Venn diagram of the overlapping regions
venn_regions <- venn.diagram(
   x=file1_vec,
   y=file2_vec,
   filename=NULL,
   fill=c("skyblue","pink"),
   alpha=c(0.6,0.6),
   cat.col=c("skyblue","pink"),
   cat.cex=2,
   main=paste("File1 VS. File2")
)

# Add the region sizes as labels
venn_regions$labels <- c(
   paste(length(setdiff(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Unique to File1"),
   paste(length(intersect(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Overlap"),
   paste(length(setdiff(unlist(file2_vec), unlist(file1_vec))), "bp\n", "Unique to File2")
)

# Draw the diagram
png("venn_diagram.png", width=1000, height=1000)
grid.draw(venn_regions)
dev.off()

#########
library(VennDiagram)

# Read in the two files
file1 <- read.table("pre_granulosa_overlaps.txt", header=TRUE, sep="\t")
file2 <- read.table("pre_sertoli_overlaps.txt", header=TRUE, sep="\t")

# Create named vectors for each chromosome in each file
file1_vec <- lapply(unique(file1$Chromosome), function(chr){
  chr_pos <- file1$Position[file1$Chromosome == chr]
  if (length(chr_pos) > 0) {
    chr_pos <- paste(as.numeric(unlist(strsplit(chr_pos, "-"))), collapse=",")
    names(chr_pos) <- chr
  } else {
    chr_pos <- NULL
  }
  return(chr_pos)
})
file2_vec <- lapply(unique(file2$Chromosome), function(chr){
  chr_pos <- file2$Position[file2$Chromosome == chr]
  if (length(chr_pos) > 0) {
    chr_pos <- paste(as.numeric(unlist(strsplit(chr_pos, "-"))), collapse=",")
    names(chr_pos) <- chr
  } else {
    chr_pos <- NULL
  }
  return(chr_pos)
})

# Create a Venn diagram of the overlapping regions
venn_regions <- venn.diagram(
  x=file1_vec,
  y=file2_vec,
  filename=NULL,
  fill=c("skyblue","pink"),
  alpha=c(0.6,0.6),
  cat.col=c("skyblue","pink"),
  cat.cex=2,
  main=paste("File1 VS. File2")
)

# Add the region sizes as labels
venn_regions$labels <- c(
  paste(length(setdiff(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Unique to File1"),
  paste(length(intersect(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Overlap"),
  paste(length(setdiff(unlist(file2_vec), unlist(file1_vec))), "bp\n", "Unique to File2")
)

# Draw the diagram
png("venn_diagram.png", width=1000, height=1000)
grid.draw(venn_regions)
dev.off()


###
library(VennDiagram)

# Read in the two files
file1 <- read.table("pre_granulosa_overlaps.txt", header=TRUE, sep="\t")
file2 <- read.table("pre_sertoli_overlaps.txt", header=TRUE, sep="\t")

# Create named vectors for each chromosome in each file
file1_vec <- lapply(unique(file1$Chromosome), function(chr){
   chr_pos <- paste(file1$Position[file1$Chromosome==chr], collapse=",")
   names(chr_pos) <- chr
   return(chr_pos)
})

# Create named vectors for each chromosome in file2
file2_vec <- list()
for (chr in unique(file2$Chromosome)) {
   chr_pos <- paste(file2$Position[file2$Chromosome==chr], collapse=",")
   names(chr_pos) <- chr
   file2_vec[[chr]] <- chr_pos
}

# Fill in empty named vectors for missing chromosomes in file2
for (chr in unique(file1$Chromosome)) {
   if (!chr %in% names(file2_vec)) {
      file2_vec[[chr]] <- ""
   }
}

# Create a Venn diagram of the overlapping regions
venn_regions <- venn.diagram(
   x=file1_vec,
   y=file2_vec,
   filename=NULL,
   fill=c("skyblue","pink"),
   alpha=c(0.6,0.6),
   cat.col=c("skyblue","pink"),
   cat.cex=2,
   main=paste("File1 VS. File2")
)

# Add the region sizes as labels
venn_regions$labels <- c(
   paste(length(setdiff(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Unique to File1"),
   paste(length(intersect(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Overlap"),
   paste(length(setdiff(unlist(file2_vec), unlist(file1_vec))), "bp\n", "Unique to File2")
)

# Draw the diagram
png("venn_diagram.png", width=1000, height=1000)
grid.draw(venn_regions)
dev.off()
#############
library(VennDiagram)

# Read in the two files
file1 <- read.table("pre_granulosa_overlaps.txt", header=TRUE, sep="\t")
file2 <- read.table("pre_sertoli_overlaps.txt", header=TRUE, sep="\t")

# Define a helper function to convert a position string to a numeric vector
parse_positions <- function(pos_str) {
  ranges <- strsplit(pos_str, ",")
  all_positions <- lapply(ranges, function(range) {
    range_vals <- as.numeric(strsplit(range, "-")[[1]])
    seq(from = range_vals[1], to = range_vals[2])
  })
  unique(unlist(all_positions))
}

# Create named vectors for each chromosome in each file
file1_vec <- lapply(unique(file1$Chromosome), function(chr){
  chr_pos <- ifelse(any(file1$Chromosome==chr), parse_positions(file1$Position[file1$Chromosome==chr]), 0)
  names(chr_pos) <- chr
  return(chr_pos)
})
file2_vec <- lapply(unique(file2$Chromosome), function(chr){
  chr_pos <- ifelse(any(file2$Chromosome==chr), parse_positions(file2$Position[file2$Chromosome==chr]), 0)
  names(chr_pos) <- chr
  return(chr_pos)
})

# Create a Venn diagram of the overlapping regions
venn_regions <- venn.diagram(
  x=file1_vec,
  y=file2_vec,
  filename=NULL,
  fill=c("skyblue","pink"),
  alpha=c(0.6,0.6),
  cat.col=c("skyblue","pink"),
  cat.cex=2,
  main=paste("File1 VS. File2")
)

# Add the region sizes as labels
venn_regions$labels <- c(
  paste(length(setdiff(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Unique to File1"),
  paste(length(intersect(unlist(file1_vec), unlist(file2_vec))), "bp\n", "Overlap"),
  paste(length(setdiff(unlist(file2_vec), unlist(file1_vec))), "bp\n", "Unique to File2")
)

# Draw the diagram
png("venn_diagram.png", width=1000, height=1000)
grid.draw(venn_regions)
dev.off()


####
library(VennDiagram)

# Read in the two files
file1 <- read.table("pre_granulosa_overlaps.txt", header=TRUE, sep="\t")
file2 <- read.table("pre_sertoli_overlaps.txt", header=TRUE, sep="\t")

# Convert positions to numeric
file1$Position <- as.numeric(unlist(strsplit(as.character(file1$Position), "-")))
file2$Position <- as.numeric(unlist(strsplit(as.character(file2$Position), "-")))

# Create named vectors for each chromosome in each file
file1_vec <- lapply(unique(file1$Chromosome), function(chr){
  if (chr %in% unique(file2$Chromosome)) {
    chr_pos <- file1$Position[file1$Chromosome==chr]
    chr_pos <- setdiff(chr_pos, file2$Position[file2$Chromosome==chr])
    names(chr_pos) <- chr
  } else {
    chr_pos <- file1$Position[file1$Chromosome==chr]
    names(chr_pos) <- chr
  }
  return(chr_pos)
})

file2_vec <- lapply(unique(file2$Chromosome), function(chr){
  if (chr %in% unique(file1$Chromosome)) {
    chr_pos <- file2$Position[file2$Chromosome==chr]
    chr_pos <- setdiff(chr_pos, file1$Position[file1$Chromosome==chr])
    names(chr_pos) <- chr
  } else {
    chr_pos <- file2$Position[file2$Chromosome==chr]
    names(chr_pos) <- chr
  }
  return(chr_pos)
})

# Create a Venn diagram of the overlapping regions
venn_regions <- venn.diagram(
  x=file1_vec,
  y=file2_vec,
  filename=NULL,
  fill=c("skyblue","pink"),
  alpha=c(0.6,0.6),
  cat.col=c("skyblue","pink"),
  cat.cex=2,
  main=paste("File1 VS. File2")
)

# Add the region sizes as labels
unique_A <- sum(unlist(lapply(file1_vec, length)))
unique_B <- sum(unlist(lapply(file2_vec, length)))
common <- sum(unlist(lapply(intersect(names(file1_vec), names(file2_vec)), function(chr){
  if (length(file1_vec[[chr]]) > 0 & length(file2_vec[[chr]]) > 0) {
    intersect(file1_vec[[chr]], file2_vec[[chr]])
  } else {
    0
  }
})))

venn_regions$labels <- c(
  paste(unique_A, "bp\n", "Unique to File1"),
  paste(common, "bp\n", "Overlap"),
  paste(unique_B, "bp\n", "Unique to File2")
)

# Draw the diagram
png("venn_diagram.png", width=1000, height=1000)
grid.draw(venn_regions)
dev.off()



############
library(VennDiagram)

# Read in the two files
file1 <- read.table("pre_granulosa_overlaps.txt", header=TRUE, sep="\t")
file2 <- read.table("pre_sertoli_overlaps.txt", header=TRUE, sep="\t")

# Create named vectors for each chromosome in each file
file1_vec <- lapply(unique(file1$Chromosome), function(chr){
  chr_pos <- file1$Position[file1$Chromosome==chr]
  if (nrow(subset(file2, Chromosome == chr)) == 0) {
    chr_pos <- c(chr_pos, 0)
  }
  names(chr_pos) <- chr
  return(chr_pos)
})
file2_vec <- lapply(unique(file2$Chromosome), function(chr){
  chr_pos <- file2$Position[file2$Chromosome==chr]
  if (nrow(subset(file1, Chromosome == chr)) == 0) {
    chr_pos <- c(chr_pos, 0)
  }
  names(chr_pos) <- chr
  return(chr_pos)
})

# Create a Venn diagram of the overlapping regions
venn_regions <- venn.diagram(
  x=file1_vec,
  y=file2_vec,
  filename=NULL,
  fill=c("skyblue","pink"),
  alpha=c(0.6,0.6),
  cat.col=c("skyblue","pink"),
  cat.cex=2,
  main=paste("File1 VS. File2")
)

# Add the region sizes as labels
venn_regions$labels <- c(
  paste(sum(sapply(file1_vec, function(x) length(x[x > 0]))), "bp\n", "Unique to File1"),
  paste(sum(sapply(file2_vec, function(x) length(x[x > 0]))), "bp\n", "Unique to File2"),
  paste(sum(sapply(file1_vec, function(x) length(x[x > 0 & x %in% file2_vec[[names(x)]]]))), "bp\n", "Overlap")
)

# Draw the diagram
png("venn_diagram.png", width=1000, height=1000)
grid.draw(venn_regions)
dev.off()


#############33

# Load required packages
library(VennDiagram)

# Read in the text file and extract the relevant values
data <- read.table("pre_granulosa_HO_VS._pre_sertoli_HO.txt", header=FALSE, sep="_")
area_a <- data[nrow(data), 2]
area_b <- data[nrow(data), 3]
shared_area <- data[nrow(data), 4]

# Create the Venn diagram
venn.diagram(
  x = list(A = area_a, B = area_b),
  filename = paste(data[1, 1:3], "VS.", data[1, 5:7], ".png", sep=""),
  main = paste(data[1, 1:3], "regulatory elements\nvs.\n", data[1, 5:7], "regulatory elements"),
  fill = c("lightblue", "pink"),
  alpha = 0.50,
  cat.cex = 1.2,
  cat.pos = c(0, 0),
  cat.dist = 0.1,
  cex = 2,
  fontfamily = "sans",
  lty = "blank",
  col = "purple",
  cat.col = c("black", "black"),
  cat.fontfamily = "sans",
  cat.fontface = "bold",
  margin = 0.1,
  euler.d = TRUE,
  counts = list(c(area_a - shared_area, shared_area, area_b - shared_area)),
  counts.position = c(0.5, 0.5),
  counts.col = "black",
  counts.fontfamily = "sans",
  counts.fontface = "bold",
  counts.cex = 1.5
)

# Read in the data
data <- read.table("pre_granulosa_HO_VS._pre_sertoli_HO.txt", header = TRUE, sep = "\t")

# Extract circle names from file name
circle_names <- gsub("_", " ", gsub("\\.txt", "", basename("pre_granulosa_HO_VS._pre_sertoli_HO.txt")))
circle_a_name <- substr(circle_names, 1, regexpr(" VS.", circle_names) - 1)
circle_b_name <- substr(circle_names, regexpr("VS. ", circle_names) + 4, nchar(circle_names))

# Get areas for each circle
circle_a_area <- data[length(data[,2]), 2]
circle_b_area <- data[length(data[,2]), 3]
shared_area <- data[length(data[,2]), 4]

# Create Venn diagram
library(VennDiagram)

# Set circle colors
circle_a_color <- "#ADD8E6" # Light blue
circle_b_color <- "#FFC0CB" # Pink
shared_color <- "#A020F0" # Purple

# Set font size and style
font_size <- 20
font_face <- "bold"

# Set diagram title
title <- paste(circle_a_name, "regulatory elements", "vs.", circle_b_name, "regulatory elements", sep = " ")

# Create diagram
venn.diagram(x = list(A = circle_a_area, B = circle_b_area),
             filename = paste(circle_a_name, "VS.", circle_b_name, ".png", sep = ""),
             main = title,
             fill = c(circle_a_color, circle_b_color),
             alpha = c(0.5, 0.5),
             label.col = "black",
             cex = font_size,
             fontface = font_face,
             cat.dist = c(0.07, 0.07),
             cat.cex = font_size,
             cat.fontface = font_face,
             cat.col = c(circle_a_color, circle_b_color),
             cat.pos = c(-5, 5),
             cat.default.pos = "outer",
             cat.just = list(c(0.5, 0.5), c(0.5, 0.5)),
             cat.prop = 1,
             cat.ellipse = 0,
             euler.d = TRUE,
             ind = TRUE,
             lty = "blank",
             cex.prop = 1,
             col = c(circle_a_color, circle_b_color, shared_color),
             lwd = c(3, 3, 3),
             fill.alpha = c(0.5, 0.5, 0.5),
             alpha = c(0.5, 0.5, 0.5),
             cat.alpha = c(0.5, 0.5))




library(VennDiagram)

file_name <- "pre_granulosa_HO_VS._pre_sertoli_HO.txt"

# Extract circle names from the file name
circle_A_name <- gsub("_VS\\..*$", "", file_name)
circle_B_name <- gsub("^.*_VS\\.", "", gsub("\\.txt$", "", file_name))

# Read the file and extract relevant values
data <- read.table(file_name, header = TRUE, sep = "\t")
unique_A <- data[nrow(data), 2]
unique_B <- data[nrow(data), 3]
shared <- data[nrow(data), 4]

# Set the colors for the diagram
colors <- c("#ADD8E6", "#FFC0CB", "#9370DB")

# Create the diagram
venn.plot <- draw.pairwise.venn(
  area1 = unique_A,
  area2 = unique_B,
  cross.area = shared,
  category = c(circle_A_name, circle_B_name),
  fill = colors,
  lty = "blank",
  cex = 2.5,
  cat.cex = 2.5,
  cat.fontface = "bold",
  scaled = TRUE
)

# Add labels for each zone
label_ZoneA <- paste(circle_A_name, "regulatory elements\n", format(unique_A, big.mark = ","), sep = "")
label_ZoneB <- paste(circle_B_name, "regulatory elements\n", format(unique_B, big.mark = ","), sep = "")
label_shared <- paste("Shared\n", format(shared, big.mark = ","), sep = "")

venn.plot$labelA <- label_ZoneA
venn.plot$labelB <- label_ZoneB
venn.plot$labelAB <- label_shared

# Set title of the diagram
title <- paste(circle_A_name, "regulatory elements\nvs.\n", circle_B_name, "regulatory elements", sep = " ")
venn.plot$title <- title

# Save the diagram
png(file = paste(circle_A_name, "VS.", circle_B_name, ".png", sep = ""), width = 1200, height = 800)
grid.draw(venn.plot)
dev.off()


ENCODE guidelines for ChIP-seq recommend only using samples where more than 80% of the read pairs are unique (i.e., less than 20% duplication rate), whereas in these samples, the average duplication rate 68%.

```{r fig.width=16, fig.height=10}
#knitr::opts_chunk$set(fig.width=12, fig.height=8) 
picardata <- read.csv("picard_deduplication.csv")
#Turn your 'Category' column into a character vector
picardata$Category <- as.character(picardata$Category)
#Then turn it back into a factor with the levels in the correct order
picardata$Category <- factor(picardata$Category, levels=unique(picardata$Category))
picardata$total <- picardata$Unique.Unpaired+picardata$Duplicate.Unpaired+picardata$Unmapped
mapping_p_data <-
  picardata %>%
  transmute(sample = Category,
   unmapped = Unmapped,
   duplicates = Duplicate.Unpaired,
   unique = Unique.Unpaired
   #    unmapped = Unmapped/total,
   # wo_dup = Duplicate.Unpaired/total,
   # finally = Unique.Unpaired/total
  ) %>% 
  gather(key=type, value=count, -sample) %>%
  mutate(type=factor(type,
   levels=c("unmapped","duplicates", "unique")))

v <- c('39%','7%','54%')

#'b' %in% v

mapping_p_data %>%
  ggplot(aes(x=sample, y=count, fill=type)) + theme_bw() +
  geom_bar(stat='identity', position='stack') +
  geom_text(aes(label = ifelse(!paste0(round((count/picardata$total)*100, digits = 0),"%") %in% v , paste0(round((count/picardata$total)*100, digits = 0),"%"), "")), 
            position = position_stack(vjust = 0.5), size = 5)+
  ylab("Fraction of reads") + xlab(NULL)  +
  ggtitle("Mapped reads") +
  theme(legend.position="right", legend.text = element_text(size=25),axis.text=element_text(size=15))+
  scale_fill_manual(
    name=NULL,
    values=c("unique"="lightskyblue","duplicates"="honeydew4","unmapped"="lightgreen"),  #if will have additional features can add, "multi_mapped"= red, "some_other_type"=green),
    breaks=c("unmapped","duplicates" ,"unique")) +  #if will have additional such as multi mapped can add
  coord_flip()

```


```{r numofseq}
ts1 <- data.frame(ts$sample_name_, ts$total_sequences_,ts$num_of_peaks)
ts1$ts.total_sequences_ <- comma_format(digits = 12)(ts$total_sequences_)
ts1$unique_reads <- comma_format(digits = 12)(picardata$Unique.Unpaired)
ts1$unique_reads <- rev(ts1$unique_reads)
ts1$ts.num_of_peaks <- comma_format(digits = 12)(ts$num_of_peaks)
colnames(ts1)[1] <- "sample_name"
colnames(ts1)[2] <- "total_reads"
colnames(ts1)[3] <- "num_of_peaks"

sm <- data.frame(in_both,combined)
kable(ts1[,c(1,2,4,3)]) %>%
  kable_styling(full_width = FALSE, position = "float_left")
kable(sm) %>%
  kable_styling(full_width = FALSE, position = "left")
```

"unique_reads" column refers to reads that were mapped uniquely to the genome.

"in_both" column refers to peaks that appear in both replicates of a sample.

"combined" column refers to peaks that appear in either of the replicates.

## Correlation between reads number and peaks number
```{r}
ts2 <- data.frame(ts$total_sequences_, ts$num_of_peaks)
# Add regression line
plot(ts2$ts.total_sequences_, ts2$ts.num_of_peaks,
     xlab = "Number of Reads", ylab = "Numner of Peaks",
     pch = 19, frame = FALSE)
axis(1, at=c(0,50000000), labels=c("",""), lwd.ticks=0)
axis(2, at=c(0,200000), labels=c("",""), lwd.ticks=0)
#axis(1, at=seq(0 , 33000000, by=1000000), lwd=0, lwd.ticks=1)
my_lm <- lm(ts2$ts.num_of_peaks ~ ts2$ts.total_sequences_, data = ts2)
abline(my_lm, col = "black")
s <- summary(my_lm)
r2 <- s$adj.r.squared
mylabel = bquote(italic(R)^2 == .(format(r2, digits = 3)))
text(x = 5500000, y = 90000, mylabel)
```

# Duplicates comparison

We can see in the following diagrams that between the duplicates, there is very low overlap of peaks, even when the number of peaks is similar. We would expect most peaks would overlap but in all samples the number of peaks that overlap is less than a half, meaning the libraries aren't complex enough.

Due to all these reasons, we think the quality of this data isn't sufficient, and we must generate a new dataset of histones marks chip seq.


## Promoters - H3K4me3

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 26700, B = 57791, "A&B" = 16986), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("1-26,700", "2-57,791"), cex=1.5))
grid::grid.text("9,714", x=0.065, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("40,805", x=0.64, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("16,986", x=0.3, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("1", x=0.067, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("2", x=0.64, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```


\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 49847, B = 43760, "A&B" = 22878), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("1-49,847", "2-43,760"), cex=1.5))
grid::grid.text("26,969", x=0.1, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("20,882", x=0.7, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("22,878", x=0.4, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("1", x=0.1, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("2", x=0.7, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```
 
## Enhancers - H3K27ac

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 51579, B = 773, "A&B" = 681), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("1-51,579", "2-773"), cex=1.5))
grid::grid.text("50,898", x=0.4, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("92", x=0.8, y=0.5, gp=gpar(col="black", fontsize=15, fontface=1)) # B 
grid::grid.text("681", x=0.75, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("1", x=0.4, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("2", x=0.8, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```


\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 63741, B = 87789, "A&B" = 44506), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("1-63,741", "2-87,789"), cex=1.5))
grid::grid.text("19,235", x=0.1, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("43,283", x=0.7, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("44,506", x=0.4, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("1", x=0.1, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("2", x=0.7, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```
 
## Silencers - H3K27me3

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 55194, B = 114362, "A&B" = 29207), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("1-55,194", "2-114,362"), cex=1.5))
grid::grid.text("25,987", x=0.1, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("85,155", x=0.65, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("29,207", x=0.33, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("1", x=0.1, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("2", x=0.65, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```

\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 51978, B = 94743, "A&B" = 26825), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("1-51,978", "2-94,743"), cex=1.5))
grid::grid.text("25,153", x=0.1, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("67,918", x=0.65, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("26,825", x=0.34, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("1", x=0.1, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("2", x=0.65, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```


## Workflow

The nf-core/chipseq pipeline was used, as described on their website https://nf-co.re/chipseq/2.0.0#pipeline-summary :


```{r workflow}
grViz("
digraph workflow {

  # a 'graph' statement
  graph [overlap = true, fontsize = 13]

  # several 'node' statements
  node [shape = squre, color = Lavender, style = filled, width=7, height=0.7
        fontname = Helvetica, fontsize = 20]
  tab1 [label = 'QC: FastQC'];
  tab2 [label = 'Adapter trimming: Trim Galore'];
  tab3 [label = 'Genome alignment: BWA'];
  tab4 [label = 'Mark duplicates: Picard tools'];
  tab5 [label = 'Filtering reads - duplicates, blacklist, unmapped, multimapped etc: SAM and BED tools'];
  tab6 [label = 'Pick calling: MACS2']; 


  # several 'edge' statements
  tab1-> tab2;
  tab2 -> tab3;
  tab3 -> tab4;
  tab4 -> tab5;
  tab5 -> tab6
}
")
```


# Venn Diagrams - 1st version \n 

For the ChIP seq data, a peak is considered if it appeared in any one of the replicas. For the ATAC it's considered if it appeared in 2 replicas out of 3.

## Promoters Vs. ATAC seq

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 56528, B = 101812, "A&B" = 42663), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K4me3-56,528", "ATAC-101,8124"), cex=1.5))
grid::grid.text("13,865", x=0.06, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("59,149", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("42,663", x=0.3, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K4me3", x=0.057, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```


\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 56287, B = 125753, "A&B" = 40409), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K4me3-56,287", "ATAC-125,753"), cex=1.5))
grid::grid.text("15,878", x=0.063, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("85,344", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("40,409", x=0.275, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K4me3", x=0.057, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```
 
## Enhancers Vs. ATAC seq

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 46087, B = 101812, "A&B" = 32693), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K27ac-46,087", "ATAC-101,812"), cex=1.5))
grid::grid.text("13,394", x=0.065, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("69,119", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("32,693", x=0.275, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K27ac", x=0.065, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```


\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 90334, B = 125753, "A&B" = 58871), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K27ac-90,334", "ATAC-125,753"), cex=1.5))
grid::grid.text("31,463", x=0.065, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("66,882", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("58,871", x=0.27, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K27ac", x=0.07, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```
 
## Silencers Vs. ATAC seq

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 108276, B = 101812, "A&B" = 16116), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K27me3-108,276", "ATAC-101,812"), cex=1.5))
grid::grid.text("92,160", x=0.1, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("85,696", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("16,116", x=0.34, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K27me3", x=0.1, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```

\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 92742, B = 125753, "A&B" = 16215), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K27me3-92,742", "ATAC-125,753"), cex=1.5))
grid::grid.text("76,527", x=0.08, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("109,538", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("16,215", x=0.315, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K27me3", x=0.085, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```

## Integrated Analysis

Granulosa: \n

```{r}
v <- euler(c( B = 56528, C = 46087, D = 108276, "B&C" = 28607, "B&D" = 13451,"C&D"= 4895, "B&C&D" = 4517),"union")
plot(v, fills = c("rosybrown1","khaki1","seagreen1"), key = TRUE, counts = TRUE, labels=c("H3K4me3","H3K27ac","H3K27me3"), quantities= FALSE, legend = list(labels = c("H3K4me3-56,528","H3K27ac-46,087","H3K27me3-108,276")))
```

```{r fig.dim = c(8, 8), out.width = "50%", echo=FALSE,results='hide',fig.keep='all'}
# v <- euler(c(A = 101812, B = 56528, C = 46087, D = 108276,"A&B" = 42663, "A&C" = 32693, "A&D" = 16116, "B&C" = 28607, "B&D" = 13451,"C&D"= 4895,"A&B&C" = 26249, "A&B&D" = 10934, "B&C&D" = 4517, "A&C&D" = 4544, "A&B&C&D" = 4334),"union")
# plot(v, fills = c("lightblue","rosybrown1","khaki1","seagreen1"), key = TRUE, counts = TRUE, labels=c("ATAC","H3K4me3","H3K27ac","H3K27me3"), quantities= FALSE, legend = list(labels = c("ATAC-101,812", "H3K4me3-56,528","H3K27ac-46,087","H3K27me3-108,276"), cex=1.5))
grid.newpage()
  
# create Venn diagram with four sets
draw.quad.venn(area1 = 101812, area2 = 56528, area3 = 46087, area4 = 108276,n12 = 42663, n13 = 32693, n14 = 16116, n23 = 28607, n24 = 13451,n34= 4895,n123 = 26249, n124 = 10934, n234 = 4517, n134 = 4544, n1234 = 4334, category=c("ATAC\n 101,812","H3K4me3\n 56,528","H3K27ac\n 46,087","H3K27me3\n 108,276"),fill=c("lightblue","rosybrown1","goldenrod1","seagreen1"), cex=1.5, cat.cex = 1.5)
```

```{r}
knit_hooks$set()
```

```{r upset1 , include=FALSE, fig.width=16, fig.height=9}
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)
input <- c(
  # ATAC = 101812,
  # H3K4me3 = 56528,
  # H3K27ac = 46087,
  # H3K27me3 = 108276,
  
  "H3K4me3(56,528)&ATAC(101,812)" = 42663,
  "H3K27me3(108,276)&ATAC(101,812)" = 16116,
  "H3K27ac(46,087)&H3K27me3(108,276)" = 4895,
  "H3K27me3(108,276)&H3K4me3(56,528)" = 13451,
  "ATAC(101,812)&H3K27ac(46,087)" = 32693,
  "H3K27ac(46,087)&H3K4me3(56,528)" = 28607,
  
  "H3K27me3(108,276)&ATAC(101,812)&H3K4me3(56,528)" = 10934,
  "H3K27me3(108,276)&ATAC(101,812)&H3K27ac(46,087)" = 4544,
  "ATAC(101,812)&H3K4me3(56,528)&H3K27ac(46,087)" = 26249,
  "H3K27me3(108,276)&H3K27ac(46,087)&H3K4me3(56,528)" = 4517,
  
  "ATAC(101,812)&H3K27me3(108,276)&H3K4me3(56,528)&H3K27ac(46,087)" = 4334
)

# Plot
upset(fromExpression(input), 
      nintersects = 40, 
      nsets = 6, 
      # order.by = "degree", 
      # decreasing = F, 
      mb.ratio = c(0.6, 0.4),
      number.angles = 0, 
      text.scale = 3,
      point.size = 3.5, 
      line.size = 1.5,
      set_size.scale_max=1
      )
```
```{r}
"reprt_files/figure-html/upset1 -1.png" %>%
  image_read() %>%
  crop(left = 320, bottom = 90)
```


\n Sertoli: \n

```{r}
v <- euler(c(B = 56287, C = 90334, D = 92742, "B&C" = 38009, "B&D" = 10577,"C&D"= 7547,  "D&B&C" = 5961),"union")
plot(v, fills = c("rosybrown1","khaki1","seagreen1"), key = TRUE, counts = TRUE, labels=c("H3K4me3","H3K27ac","H3K27me3"), quantities= FALSE, legend = list(labels = c("H3K4me3-56,287","H3K27ac-90,334","H3K27me3-92,742")))
```

```{r fig.dim = c(8, 8), out.width = "50%", echo=FALSE,results='hide',fig.keep='all'}
# v <- euler(c(A = 125753, B = 56287, C = 90334, D = 92742,"A&B" = 40409, "A&C" = 58871, "A&D" = 16215, "B&C" = 38009, "B&D" = 10577,"C&D"= 7547, "A&B&C" = 34969, "A&B&D" = 8799, "D&B&C" = 5961, "A&C&D" = 6503, "A&B&C&D" = 5562),"union")
# plot(v, fills = c("lightblue","rosybrown1","khaki1","seagreen1"), key = TRUE, counts = TRUE, labels=c("ATAC","H3K4me3","H3K27ac","H3K27me3"), quantities= FALSE, legend = list(labels = c("ATAC-125,753", "H3K4me3-56,287","H3K27ac-90,334","H3K27me3-92,742"), cex=1.5))
grid.newpage()
  
# create Venn diagram with four sets
draw.quad.venn(area1 = 125753, area2 = 56287, area3 = 90334, area4 = 92742,n12 = 40409, n13 = 58871, n14 = 16215, n23 = 38009, n24 = 10577,n34= 7547, n123 = 34969, n124 = 8799, n234 = 5961, n134 = 6503, n1234 = 5562, category=c("ATAC \n 125,753","H3K4me3\n 56,287","H3K27ac\n 90,334","H3K27me3\n 92,742"),fill=c("lightblue","rosybrown1","goldenrod1","seagreen1"), cex=1.5, cat.cex = 1.5)
```

```{r upset2 , include=FALSE,fig.width=16, fig.height=10}
input <- c(
  # ATAC = 125753,
  # H3K4me3 = 56287,
  # H3K27ac = 90334,
  # H3K27me3 = 92742,
  
  "H3K4me3(56,287)&ATAC(125,753)" = 40409,
  "H3K27me3(92,742)&ATAC(125,753)" = 16215,
  "H3K27ac(90,334)&H3K27me3(92,742)" = 7547,
  "H3K27me3(92,742)&H3K4me3(56,287)" = 10577,
  "ATAC(125,753)&H3K27ac(90,334)" = 58871,
  "H3K27ac(90,334)&H3K4me3(56,287)" = 38009,
  
  "H3K27me3(92,742)&ATAC(125,753)&H3K4me3(56,287)" = 8799,
  "H3K27me3(92,742)&ATAC(125,753)&H3K27ac(90,334)" = 6503,
  "ATAC(125,753)&H3K4me3(56,287)&H3K27ac(90,334)" = 34969,
  "H3K27me3(92,742)&H3K27ac(90,334)&H3K4me3(56,287)" = 5961,
  
  "ATAC(125,753)&H3K27me3(92,742)&H3K4me3(56,287)&H3K27ac(90,334)" = 5562
)

# Plot
upset(fromExpression(input), 
      nintersects = 40, 
      nsets = 6, 
      # order.by = "degree", 
      # decreasing = F, 
      mb.ratio = c(0.6, 0.4),
      number.angles = 0, 
      text.scale = 3,
      point.size = 3.5, 
      line.size = 1.5,
      set_size.scale_max=1
      )
```
```{r}
"reprt_files/figure-html/upset2 -1.png" %>%
  image_read() %>%
  crop(left = 320, bottom = 90)
```

Out of all ATAC peaks, about 56% overlap with at least one histone mark.

```{r}
data <- data.frame(
  category=c("Unique ATAC", "Shared with histones"),
  count=c(54967,70786))
 
# Compute percentages
data$fraction = data$count / sum(data$count)

# Compute the cumulative percentages (top of each rectangle)
data$ymax = cumsum(data$fraction)

# Compute the bottom of each rectangle
data$ymin = c(0, head(data$ymax, n=-1))

# Compute label position
data$labelPosition <- (data$ymax + data$ymin) / 2

# Compute a good label
data$label <- paste0(format(round(data$fraction * 100, 2), nsmall = 2),"%")
 
# Make the plot
p <- ggplot(data, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=1, fill=category)) +
     geom_rect() + theme_void()+
  geom_label( x=4, aes(y=labelPosition, label=label), size=3) +
  theme(legend.position="right")  + 
     coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
     xlim(c(1, 4)) 
p + guides(
  fill = guide_legend(
    title = "Category",
    override.aes = aes(label = "")
  )
)
```

Of the peaks that are not shared with either histone mark, this is their division:

```{r}
data <- data.frame(
  category=c("Intergenic", "Exon", "Intron", "Promoter-TSS", "TTS"),
  count=c(97957, 9618, 96482, 16508, 9234)
)
 
# Compute percentages
data$fraction = data$count / sum(data$count)

# Compute the cumulative percentages (top of each rectangle)
data$ymax = cumsum(data$fraction)

# Compute the bottom of each rectangle
data$ymin = c(0, head(data$ymax, n=-1))

# Compute label position
data$labelPosition <- (data$ymax + data$ymin) / 2

# Compute a good label
data$label <- paste0(format(round(data$fraction * 100, 2), nsmall = 2),"%")
 
# Make the plot
p <- ggplot(data, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=1, fill=category)) +
     geom_rect() + theme_void()+
  geom_label( x=4, aes(y=labelPosition, label=label), size=3) +
  theme(legend.position="right")  + 
     coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
     xlim(c(1, 4)) 
p + guides(
  fill = guide_legend(
    title = "Category",
    override.aes = aes(label = "")
  )
)
```


# Venn Diagrams - 2nd version \n 

For the ChIP seq data, a peak is considered if it appeared in both replicas. For the ATAC, it's considered if it appeared in 2 replicas out of 3.

## Promoters Vs. ATAC seq

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 16982, B = 101812, "A&B" = 16156), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K4me3-16,156", "ATAC-101,8124"), cex=1.5))
grid::grid.text("826", x=0.035, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("85,656", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("16,156", x=0.17, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K4me3", x=0.057, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```


\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 22877, B = 125753, "A&B" = 22012), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K4me3-22,877", "ATAC-125,753"), cex=1.5))
grid::grid.text("865", x=0.035, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("103,741", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("22,012", x=0.17, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K4me3", x=0.057, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```
 
## Enhancers Vs. ATAC seq

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 680, B = 101812, "A&B" = 659), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K27ac-680", "ATAC-101,812"), cex=1.5))
grid::grid.text("21", x=0.025, y=0.525, gp=gpar(col="black", fontsize=15, fontface=1)) # A 
grid::grid.text("101,153", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("659", x=0.04, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K27ac", x=0.057, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```


\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 44505, B = 125753, "A&B" = 39539), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K27ac-44,505", "ATAC-125,753"), cex=1.5))
grid::grid.text("4,966", x=0.045, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("86,214", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("39,539", x=0.27, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K27ac", x=0.057, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```
 
## Silencers Vs. ATAC seq

Granulosa: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 29206, B = 101812, "A&B" = 9071), "union")
plot(v,fills = c("lightsalmon", "rosybrown1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K27me3-20,206", "ATAC-101,812"), cex=1.5))
grid::grid.text("20,135", x=0.1, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("92,741", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("9,071", x=0.23, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K27me3", x=0.1, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```

\n Sertoli: \n

```{r fig.dim = c(8, 8), out.width = "50%"}
v <- euler(c(A = 26824, B = 125753, "A&B" = 10005), "union")
plot(v,fills = c("lightslateblue","lightskyblue1"),edges = FALSE, key = TRUE, counts = TRUE, labels=FALSE, quantities=FALSE, legend = list(labels = c("H3K27me3-26,824", "ATAC-125,753"), cex=1.5))
grid::grid.text("16,819", x=0.07, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A 
grid::grid.text("115,748", x=0.54, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # B 
grid::grid.text("10,005", x=0.2, y=0.5, gp=gpar(col="black", fontsize=20, fontface=1)) # A+B 
grid::grid.text("H3K27me3", x=0.085, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GM 
grid::grid.text("ATAC", x=0.54, y=0.55, gp=gpar(col="black", fontsize=15, fontface=1)) # GONEN 
```

## Integrated Analysis

Granulosa: \n

```{r}
v <- euler(c(A = 16982, B = 680, C = 29206, "A&B" = 460, "A&C" = 3647,"B&C"=14, "A&B&C" = 13),"union")
plot(v, fills = c("rosybrown1","khaki1","seagreen1"), key = TRUE, counts = TRUE, labels=c("H3K4me3","H3K27ac","H3K27me3"), quantities= FALSE, legend = list(labels = c( "H3K4me3-16,982","H3K27ac-680","H3K27me3-29,206")), cex=0.75)
```

```{r fig.dim = c(8, 8), out.width = "50%", echo=FALSE,results='hide',fig.keep='all'}
# v <- euler(c(A = 101812, B = 16982, C = 680, D = 29206,"A&B" = 16156, "A&C" = 659, "A&D" = 9071, "B&C" = 460, "B&D" = 3647,"C&D"=14, "A&B&C" = 458,"A&C&D"=14, "A&B&D" = 3478, "B&C&D" = 13, "A&B&C&D" = 13),"union")
# plot(v, fills = c("lightblue","rosybrown1","khaki1","seagreen1"), key = TRUE, counts = TRUE, labels=c("ATAC","H3K4me3","H3K27ac","H3K27me3"), quantities= FALSE, legend = list(labels = c("ATAC-101,812", "H3K4me3-16,982","H3K27ac-680","H3K27me3-29,206"), cex=1.5))

grid.newpage()
  
# create Venn diagram with four sets
draw.quad.venn(area1=101812, area2 = 16982, area3 = 680, area4 = 29206,n12 = 16156, n13 = 659, n14 = 9071, n23 = 460, n24 = 3647, n34 =14, n123 = 458, n124 = 3478,n134= 14 ,n234 = 13, n1234 = 13, category=c("ATAC\n 101,812","H3K4me3\n 16,982","H3K27ac\n 680","H3K27me3\n 29,206"),fill=c("lightblue","rosybrown1","goldenrod1","seagreen1"), cat.cex = 1.5, cex = 1.5)
```



```{r upset3 , include=FALSE, fig.width=16, fig.height=9}
input <- c(
  # ATAC = 101812,
  # H3K4me3 = 16982,
  # H3K27ac = 680,
  # H3K27me3 = 29206,
  "H3K4me3(16,982)&ATAC(101,812)" = 16156,
  "H3K27me3(29,206)&ATAC(101,812)" = 9071,
  "H3K27ac(680)&H3K27me3(29,206)" = 14,
  "H3K27me3(29,206)&H3K4me3(16,982)" = 3647,
  "ATAC(101,812)&H3K27ac(680)" = 659,
  "H3K27ac(680)&H3K4me3(16,982)" = 460,
  "H3K27me3(29,206)&ATAC(101,812)&H3K4me3(16,982)" = 3478,
  "H3K27me3(29,206)&ATAC(101,812)&H3K27ac(680)" = 14,
  "ATAC(101,812)&H3K4me3(16,982)&H3K27ac(680)" = 458,
  "H3K27me3(29,206)&H3K27ac(680)&H3K4me3(16,982)" = 13,
  "ATAC(101,812)&H3K27me3(29,206)&H3K4me3(16,982)&H3K27ac(680)" = 13
)

# Plot
upset(fromExpression(input),
      nintersects = 40, 
      nsets = 4, 
      # order.by = "degree", 
      # decreasing = F, 
      mb.ratio = c(0.6, 0.4),
      number.angles = 0, 
      text.scale = 3,
      point.size = 3.5, 
      line.size = 1.5,
      set_size.scale_max=1
      )
```
```{r}
"reprt_files/figure-html/upset3 -1.png" %>%
  image_read() %>%
  crop(left = 320, bottom = 90)
```


\n Sertoli: \n

```{r}
v <- euler(c(A = 22877, B = 44505, C = 26824,"A&B" = 18846, "A&C" = 4531,"B&C"= 2494, "A&B&C" = 1994),"union")
plot(v, fills = c("rosybrown1","khaki1","seagreen1"), key = TRUE, counts = TRUE, labels=c("H3K4me3","H3K27ac","H3K27me3"), quantities= FALSE, legend = list(labels = c( "H3K4me3-22,877","H3K27ac-44,505","H3K27me3-26,824")))
```

```{r fig.dim = c(8, 8), out.width = "50%", echo=FALSE,results='hide',fig.keep='all'}
# v <- euler(c(A = 125753, B = 22877, C = 44505, D = 26824,"A&B" = 22012, "A&C" = 39539, "A&D" = 10005, "B&C" = 18846, "B&D" = 4531,"C&D"= 2494,"A&B&C" = 18517, "A&B&D" = 4273,"A&C&D"=2421, "B&C&D" = 1994, "A&B&C&D" = 1957),"union")
# plot(v, fills = c("lightblue","rosybrown1","khaki1","seagreen1"), key = TRUE, counts = TRUE, labels=c("ATAC","H3K4me3","H3K27ac","H3K27me3"), quantities= FALSE, legend = list(labels = c("ATAC-125,753", "H3K4me3-22,877","H3K27ac-44,505","H3K27me3-26,824"), cex=1.5))

grid.newpage()
  
# create Venn diagram with four sets
draw.quad.venn(area1=125753, area2 = 22877, area3 = 44505, area4 = 26824,n12 = 22012, n13 = 39539, n14 = 10005, n23 = 18846, n24 = 4531, n34 =2494, n123 = 18517, n124 = 4273,n134= 2421 ,n234 = 1994, n1234 = 1957, category=c("ATAC\n 125,753","H3K4me3\n 22,877","H3K27ac\n 44,505","H3K27me3\n 26,824"),fill=c("lightblue","rosybrown1","goldenrod1","seagreen1"), cex=1.5, cat.cex = 1.5)
```

```{r upset4 , include=FALSE,fig.width=16, fig.height=10}
input <- c(
  # ATAC = 125753,
  # H3K4me3 = 22877,
  # H3K27ac = 44505,
  # H3K27me3 = 26824,
  
  "H3K4me3(22,877)&ATAC(125,753)" = 22012,
  "H3K27me3(26,824)&ATAC(125,753)" = 10005,
  "H3K27ac(44,505)&H3K27me3(26,824)" = 2494,
  "H3K27me3(26,824)&H3K4me3(22,877)" = 4531,
  "ATAC(125,753)&H3K27ac(44,505)" = 39539,
  "H3K27ac(44,505)&H3K4me3(22,877)" = 18846,
  
  "H3K27me3(26,824)&ATAC(125,753)&H3K4me3(22,877)" = 4273,
  "H3K27me3(26,824)&ATAC(125,753)&H3K27ac(44,505)" = 2421,
  "ATAC(125,753)&H3K4me3(22,877)&H3K27ac(44,505)" = 18517,
  "H3K27me3(26,824)&H3K27ac(44,505)&H3K4me3(22,877)" = 1994,
  
  "ATAC(125,753)&H3K27me3(26,824)&H3K4me3(22,877)&H3K27ac(44,505)" = 1957
)

# Plot
upset(fromExpression(input), 
      nintersects = 40, 
      nsets = 6, 
      # order.by = "degree", 
      # decreasing = F, 
      mb.ratio = c(0.6, 0.4),
      number.angles = 0, 
      text.scale = 3,
      point.size = 3.5, 
      line.size = 1.5,
      set_size.scale_max=1
      )
```
```{r}
"reprt_files/figure-html/upset4 -1.png" %>%
  image_read() %>%
  crop(left = 320, bottom = 90)
```